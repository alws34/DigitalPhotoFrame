<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="css.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PhotoFrame MJPEG Viewer - Dark Mode Fixed 16:9</title>
</head>
<body>
  <div class="top-half">
    <div class="mjpeg-frame-container">
      <img id="mjpegStream" class="mjpeg-frame" src="" alt="MJPEG Stream">
    </div>
    <div id="metadataDisplay" class="metadata-display">
      <!-- Lines for caption and info will be inserted here via JavaScript -->
    </div>
    <button id="editBtn" class="edit-btn">Edit Metadata</button>
  </div>
  <div class="bottom-half">
    <!-- Reserved for additional content -->
  </div>

  <!-- Modal Overlay for Editing Metadata -->
  <div id="editModal" class="modal-overlay">
    <div class="modal-content">
      <h3>Edit Metadata</h3>
      <!-- Only editable fields: uploader and caption -->
      <label for="modalUploader">Uploader:</label>
      <input type="text" id="modalUploader">
      <label for="modalCaption">Caption:</label>
      <textarea id="modalCaption" rows="3"></textarea>
      <div class="modal-buttons">
        <button id="saveBtn">Save</button>
        <button id="cancelBtn">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const mjpegStream = document.getElementById('mjpegStream');
    const mjpegURL = 'http://localhost:5001/video_feed';
    const metadataDisplay = document.getElementById('metadataDisplay');
    const metadataURL = 'http://localhost:5002/image_metadata';
    const editBtn = document.getElementById('editBtn');
    const editModal = document.getElementById('editModal');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const modalUploader = document.getElementById('modalUploader');
    const modalCaption = document.getElementById('modalCaption');

    let currentMetadata = {};

    // Helper to format ISO date string to dd/MM/yyyy
    function formatDate(isoString) {
      const date = new Date(isoString);
      const day = ("0" + date.getDate()).slice(-2);
      const month = ("0" + (date.getMonth() + 1)).slice(-2);
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function startMJPEGStream() {
      mjpegStream.src = mjpegURL;
    }

    function fetchMetadata() {
      fetch(metadataURL)
        .then(response => response.json())
        .then(data => {
          if (data.hash) {
            currentMetadata = data;
            // Build two lines: one for caption, one for "uploader | date"
            metadataDisplay.innerHTML = `
              <div class="caption-line">${data.caption}</div>
              <div class="info-line">${data.uploader} | ${formatDate(data.date_added)}</div>
            `;
          } else {
            metadataDisplay.innerText = 'No metadata available.';
            currentMetadata = {};
          }
        })
        .catch(error => {
          metadataDisplay.innerText = 'Error fetching metadata.';
          console.error(error);
        });
    }

    function openModal() {
      editModal.style.display = 'flex';
      modalUploader.value = currentMetadata.uploader || '';
      modalCaption.value = currentMetadata.caption || '';
    }

    function closeModal() {
      editModal.style.display = 'none';
    }

    function saveMetadata() {
      const updatedMetadata = {
        uploader: modalUploader.value,
        caption: modalCaption.value
      };
      fetch('http://localhost:5002/update_metadata', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedMetadata)
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message || 'Metadata updated.');
        closeModal();
        fetchMetadata();
      })
      .catch(error => {
        alert('Error updating metadata.');
        console.error(error);
      });
    }

    function cancelEditing() {
      if (confirm("Are you sure you want to cancel editing?")) {
        closeModal();
      }
    }

    window.onload = function() {
      startMJPEGStream();
      fetchMetadata();
      setInterval(fetchMetadata, 2000);
    };

    editBtn.addEventListener('click', openModal);
    saveBtn.addEventListener('click', saveMetadata);
    cancelBtn.addEventListener('click', cancelEditing);

    // Prevent modal from closing when clicking outside
    editModal.addEventListener('click', function(e) {
      if (e.target === editModal) {
        e.stopPropagation();
      }
    });
  </script>
</body>
</html>